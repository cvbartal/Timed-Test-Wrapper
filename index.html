<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2-Minute Timed Quiz</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define the Inter font family */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Hide the form to be revealed by JS on load */
        #form-container {
            position: relative;
            opacity: 0;
            transition: opacity 0.5s;
        }
        /* Styling for the time-up overlay */
        .time-up-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            z-index: 10;
        }
        /* Ensure the iframe scales responsively */
        iframe {
            width: 100%;
            height: 80vh; /* Set a default height, adjust as needed */
            border: none;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Timed Assessment</h1>
        <p class="text-gray-600 mb-4">You have exactly <span class="font-semibold text-indigo-600">2 minutes</span> to complete and submit the form below.</p>

        <!-- Timer Display Card -->
        <div class="flex justify-center mb-6">
            <div id="timer-display" class="bg-indigo-600 text-white p-4 rounded-lg shadow-lg text-4xl font-mono min-w-[150px] text-center transition-all duration-300">
                02:00
            </div>
        </div>

        <!-- Form Container -->
        <div id="form-container" class="relative">
            <!-- Time Up Overlay (initially hidden) -->
            <div id="overlay" class="time-up-overlay hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mb-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" />
                </svg>
                <h2 class="text-4xl font-extrabold text-red-600 mb-2">TIME'S UP!</h2>
                <p class="text-lg text-gray-700">Please scroll to the end of the form and click **Submit** immediately.</p>
                <p class="text-sm text-gray-500 mt-2">No further changes can be made.</p>
            </div>

            <!-- Google Form Embedded via Iframe -->
            <iframe id="google-form"
                src=""
                frameborder="0"
                marginheight="0"
                marginwidth="0"
                title="Google Form Embedded">Loading Form...</iframe>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const TIMER_SECONDS = 120; // 2 minutes = 120 seconds

        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timer-display');
        const formContainer = document.getElementById('form-container');
        const googleFormIframe = document.getElementById('google-form');
        const overlay = document.getElementById('overlay');

        let remainingTime = TIMER_SECONDS;
        let timerInterval;
        
        /**
         * Parses the URL for a specific query parameter.
         * @param {string} name - The name of the parameter to find (e.g., 'form').
         * @returns {string | null} The decoded parameter value or null.
         */
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        /**
         * Formats seconds into MM:SS string.
         * @param {number} totalSeconds - Time left in seconds.
         * @returns {string} Formatted time string.
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * Updates the timer display and checks for time expiration.
         */
        function updateTimer() {
            remainingTime--;

            // Update display
            timerDisplay.textContent = formatTime(remainingTime);

            // Apply warning color near the end
            if (remainingTime <= 30) {
                timerDisplay.classList.remove('bg-indigo-600');
                timerDisplay.classList.add('bg-red-500', 'animate-pulse');
            }

            // Time's up!
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = '00:00';
                timerDisplay.classList.remove('animate-pulse');
                timerDisplay.classList.add('bg-red-700');
                timeIsUp();
            }
        }

        /**
         * Actions to take when the timer expires.
         */
        function timeIsUp() {
            // 1. Show the overlay to block interaction with the form
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';

            // 2. Prevent user interaction with the form elements
            formContainer.style.pointerEvents = 'none';
        }

        /**
         * Initializes the script on window load.
         */
        function initializeTimedForm() {
            const rawFormUrl = getQueryParam('form');
            const formId = getQueryParam('id');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-red-600 bg-red-100 p-4 rounded-lg mt-4';
            let cleanUrl = null;
            
            if (!rawFormUrl && !formId) {
                errorDiv.innerHTML = '<strong>ERROR: Missing Form Info.</strong> Please append the Google Form view link using `?form=` or the raw form ID using `?id=`.';
                formContainer.parentNode.insertBefore(errorDiv, formContainer);
                return; // Stop execution
            }

            if (formId) {
                // Option 1: User provides the raw Form ID (no encoding needed)
                cleanUrl = `https://docs.google.com/forms/d/e/${formId}/viewform?embedded=true`;
            } else if (rawFormUrl) {
                // Option 2: User provides the full encoded URL
                cleanUrl = rawFormUrl;

                // --- NEW CHECK: Discourage unencoded links and recommend the simple ID method ---
                // If the user attempts to use the old ?form= method but the value contains unencoded characters like "https://", 
                // we tell them to use the easier ?id= method instead.
                if (cleanUrl.includes('https://')) {
                     errorDiv.innerHTML = `
                        <p class="mb-2"><strong>STOP: Unencoded Link Detected.</strong> You are trying to use the old, complex <code>?form=</code> method with an unencoded URL.</p>
                        <p>Please use the simple **<code>?id=</code>** method instead. Find the 37-character Form ID and append it to your URL like this: <code>?id=YourFormIDHere</code></p>
                    `;
                    formContainer.parentNode.insertBefore(errorDiv, formContainer);
                    return; // Stop execution
                }

                // --- Aggressive URL Cleanup to ensure successful embedding ---
                // 1. Remove all existing query parameters (like ?usp=sharing, &ouid=...)
                const questionMarkIndex = cleanUrl.indexOf('?');
                if (questionMarkIndex !== -1) {
                    cleanUrl = cleanUrl.substring(0, questionMarkIndex);
                }
                
                // 2. Ensure the link ends in the required format for embedding
                if (cleanUrl.endsWith('/viewform')) {
                    cleanUrl += '?embedded=true';
                } else {
                    errorDiv.innerHTML = '<strong>ERROR: Invalid Form Path.</strong> The link must be the **public view link** ending in `/viewform`. Please check the URL you encoded.';
                    formContainer.parentNode.insertBefore(errorDiv, formContainer);
                    return; // Stop execution
                }
            }
            // --- End Cleanup ---

            // Debugging line (Visible in console only)
            console.log("Attempting to load URL:", cleanUrl); 

            // Set the form source and make the container visible
            googleFormIframe.src = cleanUrl; // Use the final, cleaned URL
            formContainer.style.opacity = '1';

            // Initial display
            timerDisplay.textContent = formatTime(TIMER_SECONDS);

            // Start the countdown
            timerInterval = setInterval(updateTimer, 1000);
        }

        window.onload = initializeTimedForm;
    </script>
</body>
</html>
